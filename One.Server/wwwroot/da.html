<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <title>è®¾å¤‡åœ¨çº¿ç›‘æ§</title>

    <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@8.0.0/dist/browser/signalr.min.js"></script>

    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
            background: #f5f6fa;
            padding: 20px;
        }

        h1 {
            margin-bottom: 10px;
        }

        .toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        select, input {
            padding: 5px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
        }

        th, td {
            padding: 8px;
            border-bottom: 1px solid #ddd;
            text-align: left;
        }

        th {
            background: #f0f0f0;
        }

        .online {
            color: green;
            font-weight: bold;
        }

        .offline {
            color: red;
        }
    </style>
</head>

<body>

    <h1>ğŸ“¡ è®¾å¤‡åœ¨çº¿çŠ¶æ€</h1>

    <div class="toolbar">
        <input id="filterApp" placeholder="AppName" />
        <input id="filterVersion" placeholder="Version" />
        <select id="filterOnline">
            <option value="">å…¨éƒ¨</option>
            <option value="true">åœ¨çº¿</option>
            <option value="false">ç¦»çº¿</option>
        </select>
    </div>

    <table>
        <thead>
            <tr>
                <th>ClientID</th>
                <th>HostName</th>
                <th>App</th>
                <th>Version</th>
                <th>IP</th>
                <th>çŠ¶æ€</th>
                <th>æœ€åå¿ƒè·³</th>
            </tr>
        </thead>
        <tbody id="deviceTable"></tbody>
    </table>

    <script>
        let devices = [];

        /* =============================
           åˆå§‹åŒ– HTTP æ•°æ®
        ============================= */
        async function loadDevices() {
            const res = await fetch('/api/client/list');
            devices = await res.json();

            // åˆå§‹åŒ– Online å’Œ LastSeen å­—æ®µ
            devices.forEach(d => {
                d.Online = d.Online ?? false;
                d.LastSeen = d.LastSeen ?? null;
            });

            render();
        }

        /* =============================
           SignalR è¿æ¥
        ============================= */
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/upgradeHub?role=dashboard", {
                accessTokenFactory: () => localStorage.getItem("token") || ""
            })
            .withAutomaticReconnect()
            .build();

        connection.on("ClientOnline", data => {
            const dev = devices.find(d => d.ClientID === data.ClientID);
            //if (dev) {
            //    dev.Online = true;
            //    dev.LastSeen = new Date().toLocaleString();
            //    render();
            //}
            if (!dev) {
                devices.push({
                    ...data,
                    Online: true
                });
            } else {
                dev.Online = true;
                dev.LastSeen = new Date(data.LastSeen).toLocaleString();
            }
        });

        connection.on("ClientOffline", data => {
            const dev = devices.find(d => d.ClientID === data.ClientID);
            if (dev) {
                dev.Online = false;
                render();
            }
        });

        connection.start()
            .then(() => console.log("SignalR connected"))
            .catch(console.error);

        /* =============================
           æ¸²æŸ“ & ç­›é€‰
        ============================= */
        function render() {
            const tbody = document.getElementById("deviceTable");
            tbody.innerHTML = "";

            const app = document.getElementById("filterApp").value;
            const ver = document.getElementById("filterVersion").value;
            const online = document.getElementById("filterOnline").value;

            devices
                .filter(d =>
                    (!app || d.AppName?.includes(app)) &&
                    (!ver || d.Version?.includes(ver)) &&
                    (online === "" || String(d.Online) === online)
                )
                .forEach(d => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                            <td>${d.ClientID}</td>
                            <td>${d.HostName}</td>
                            <td>${d.AppName}</td>
                            <td>${d.Version}</td>
                            <td>${d.Ip}</td>
                            <td class="${d.Online ? 'online' : 'offline'}">
                                ${d.Online ? 'åœ¨çº¿' : 'ç¦»çº¿'}
                            </td>
                            <td>${d.LastSeen ?? ''}</td>
                        `;
                    tbody.appendChild(tr);
                });
        }

        document.querySelectorAll("input,select")
            .forEach(el => el.addEventListener("input", render));

        loadDevices();
    </script>

</body>
</html>
