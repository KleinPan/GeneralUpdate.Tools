<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>è®¾å¤‡ç›‘æ§ä¸­å¿ƒ</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="layout">
        <aside class="sidebar">
            <div class="logo">
                <div class="logo-icon">ğŸ“¡</div>
                è®¾å¤‡ç›‘æ§ä¸­å¿ƒ
            </div>
            <nav class="menu">
                <a class="active" data-page="dashboard">æ¦‚è§ˆé¢æ¿</a>
                <a data-page="devices">è®¾å¤‡åˆ—è¡¨</a>
                <a data-page="history">è¿æ¥å†å²</a>
                <a data-page="settings">è®¾ç½®</a>
            </nav>
            <div class="sidebar-footer">
                <div class="connection-status">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="connectionText">æ­£åœ¨è¿æ¥...</span>
                </div>
            </div>
        </aside>

        <main class="content">
            <div class="page-header">
                <h2 id="title">æ¦‚è§ˆé¢æ¿</h2>
                <div class="page-header-actions">
                    <button class="btn" onclick="load()">ğŸ”„ åˆ·æ–°</button>
                    <button class="btn btn-primary" onclick="load()">ç«‹å³åˆ·æ–°</button>
                </div>
            </div>
            <div class="divider"></div>

            <!-- æ¦‚è§ˆ -->
            <section id="page-dashboard" class="page active">
                <div class="summary">
                    <div class="summary-card">
                        <div class="summary-item">
                            <h4>è®¾å¤‡æ€»æ•°</h4>
                            <div class="value" id="total">0</div>
                            <div class="trend">â†‘ å®æ—¶ç›‘æ§</div>
                        </div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-item">
                            <h4>åœ¨çº¿è®¾å¤‡</h4>
                            <div class="value" id="online">0</div>
                            <div class="trend">âœ“ æ­£å¸¸è¿è¡Œ</div>
                        </div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-item">
                            <h4>ä»Šæ—¥è¿æ¥</h4>
                            <div class="value" id="today">0</div>
                            <div class="trend">ğŸ“ˆ æ´»è·ƒæ•°æ®</div>
                        </div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-item">
                            <h4>ç³»ç»ŸçŠ¶æ€</h4>
                            <div class="value" style="font-size: 20px; color: #19c2a2;">æ­£å¸¸</div>
                            <div class="trend">âœ“ æœåŠ¡æ­£å¸¸</div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">å¿«é€Ÿç»Ÿè®¡</h3>
                    </div>
                    <p style="color: #64748b; line-height: 1.8;">
                        æ¬¢è¿ä½¿ç”¨è®¾å¤‡ç›‘æ§ä¸­å¿ƒã€‚ç³»ç»Ÿæ­£åœ¨å®æ—¶ç›‘æ§æ‰€æœ‰åœ¨çº¿è®¾å¤‡çš„çŠ¶æ€å˜åŒ–ï¼Œ
                        æ‚¨å¯ä»¥ç‚¹å‡»ä¸Šæ–¹åˆ·æ–°æŒ‰é’®è·å–æœ€æ–°æ•°æ®ï¼Œæˆ–åˆ‡æ¢å·¦ä¾§å¯¼èˆªæ æŸ¥çœ‹ä¸åŒé¡µé¢ã€‚
                    </p>
                </div>
            </section>

            <!-- è®¾å¤‡åˆ—è¡¨ -->
            <section id="page-devices" class="page">
                <div class="card" style="margin-bottom: 20px;">
                    <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                        <input type="text" id="deviceFilter" placeholder="æœç´¢è®¾å¤‡å/IP/åº”ç”¨åç§°" 
                            style="flex: 1; min-width: 200px; padding: 10px 16px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px;"
                            oninput="filterDevices()">
                        <span style="color: #64748b; font-size: 13px;" id="filterCount">æ˜¾ç¤º 0 æ¡</span>
                    </div>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>è®¾å¤‡å</th>
                                <th>IP åœ°å€</th>
                                <th>åº”ç”¨åç§°</th>
                                <th>ç‰ˆæœ¬å·</th>
                                <th>çŠ¶æ€</th>
                                <th>ä¸Šçº¿æ—¶é—´</th>
                            </tr>
                        </thead>
                        <tbody id="tbody">
                            <tr>
                                <td colspan="6" style="text-align: center; color: #94a3b8; padding: 40px;">
                                    æ­£åœ¨åŠ è½½è®¾å¤‡æ•°æ®...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- è¿æ¥å†å² -->
            <section id="page-history" class="page">
                <div class="history-list" id="historyList">
                    <div class="history-item">
                        <div class="history-icon success">âœ”</div>
                        <div class="history-content">
                            <div class="history-title">ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ</div>
                            <div class="history-meta">è®¾å¤‡ç›‘æ§ä¸­å¿ƒå·²å¯åŠ¨ï¼Œç­‰å¾…è®¾å¤‡è¿æ¥...</div>
                        </div>
                        <div class="history-time">
                            <div class="time">--</div>
                            <div class="date">å‡†å¤‡å°±ç»ª</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- è®¾ç½® -->
            <section id="page-settings" class="page">
                <div class="settings-group">
                    <div class="settings-item">
                        <div>
                            <div class="settings-label">è‡ªåŠ¨åˆ·æ–°</div>
                            <div class="settings-desc">è‡ªåŠ¨è·å–æœ€æ–°è®¾å¤‡æ•°æ®</div>
                        </div>
                        <div class="toggle active" onclick="this.classList.toggle('active')"></div>
                    </div>
                    <div class="settings-item">
                        <div>
                            <div class="settings-label">å®æ—¶é€šçŸ¥</div>
                            <div class="settings-desc">è®¾å¤‡ä¸Šçº¿/ç¦»çº¿æ—¶æ˜¾ç¤ºé€šçŸ¥</div>
                        </div>
                        <div class="toggle active" onclick="this.classList.toggle('active')"></div>
                    </div>
                    <div class="settings-item">
                        <div>
                            <div class="settings-label">éŸ³æ•ˆæç¤º</div>
                            <div class="settings-desc">è¿æ¥çŠ¶æ€å˜åŒ–æ—¶æ’­æ”¾æç¤ºéŸ³</div>
                        </div>
                        <div class="toggle" onclick="this.classList.toggle('active')"></div>
                    </div>
                </div>

                <div class="settings-group">
                    <div class="settings-item">
                        <div>
                            <div class="settings-label">åˆ·æ–°é—´éš”</div>
                            <div class="settings-desc">æ•°æ®è‡ªåŠ¨åˆ·æ–°é¢‘ç‡ï¼ˆç§’ï¼‰</div>
                        </div>
                        <input type="number" id="refreshInterval" value="3" min="1" max="60" style="
                            width: 80px;
                            padding: 8px 12px;
                            border: 1px solid #e2e8f0;
                            border-radius: 8px;
                            font-size: 14px;
                            text-align: center;
                        " onchange="updateRefreshInterval()">
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>
    <script>
        const APIList = "/api/client/list";
        let allDevices = []; // å­˜å‚¨æ‰€æœ‰è®¾å¤‡æ•°æ®
        let refreshTimer = null;
        let refreshInterval = 3000; // é»˜è®¤3ç§’

        // SignalRè¿æ¥åˆå§‹åŒ–
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/upgradeHub?role=dashboard")
            .configureLogging(signalR.LogLevel.Information)
            .build();

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(date) {
            return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }

        function formatDate(date) {
            return date.toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' });
        }

        // åˆ›å»ºå†å²è®°å½•é¡¹
        function createHistoryItem(icon, iconClass, title, ip, meta) {
            const now = new Date();
            const item = document.createElement('div');
            item.className = 'history-item';
            item.style.animation = 'fadeIn 0.3s ease';
            item.innerHTML = `
                <div class="history-icon ${iconClass}">${icon}</div>
                <div class="history-content">
                    <div class="history-title">${title} <span class="history-ip">(${ip})</span></div>
                    <div class="history-meta">${meta}</div>
                </div>
                <div class="history-time">
                    <div class="time">${formatTime(now)}</div>
                    <div class="date">${formatDate(now)}</div>
                </div>
            `;
            return item;
        }

        // å¤„ç†åœ¨çº¿å®¢æˆ·ç«¯é€šçŸ¥
        connection.on("ClientOnline", (client) => {
            const historyList = document.getElementById("historyList");
            const item = createHistoryItem(
                'âœ”',
                'success',
                `${client.machineInfo.hostName} - ${client.appInfo.appName}`,
                client.ip,
                `å®¢æˆ·ç«¯æˆåŠŸè¿æ¥åˆ°æœåŠ¡å™¨`
            );
            historyList.insertBefore(item, historyList.firstChild);
            
            // é™åˆ¶æ˜¾ç¤ºæ•°é‡
            while (historyList.children.length > 50) {
                historyList.removeChild(historyList.lastChild);
            }
        });

        // å¤„ç†ç¦»çº¿å®¢æˆ·ç«¯ä¸‹çº¿é€šçŸ¥
        connection.on("ClientOffline", (client) => {
            const historyList = document.getElementById("historyList");
            const item = createHistoryItem(
                'âœ–',
                'error',
                `${client.machineInfo.hostName} - ${client.appInfo.appName}`,
                client.ip,
                `å®¢æˆ·ç«¯è¿æ¥æ–­å¼€`
            );
            historyList.insertBefore(item, historyList.firstChild);
            
            while (historyList.children.length > 50) {
                historyList.removeChild(historyList.lastChild);
            }
        });

        // å¯åŠ¨SignalRè¿æ¥
        async function startConnection() {
            if (connection.state !== signalR.HubConnectionState.Disconnected) {
                return;
            }

            try {
                await connection.start();
                updateConnectionStatus(true);
            } catch (err) {
                console.error("SignalR Connection Error:", err);
                updateConnectionStatus(false);
                setTimeout(startConnection, 5000);
            }
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€UI
        function updateConnectionStatus(isConnected) {
            const statusDot = document.getElementById("statusDot");
            const connectionText = document.getElementById("connectionText");
            
            if (isConnected) {
                statusDot.classList.add('connected');
                connectionText.textContent = "å·²è¿æ¥ - å®æ—¶ç›‘æ§ä¸­";
            } else {
                statusDot.classList.remove('connected');
                connectionText.textContent = "è¿æ¥æ–­å¼€ - æ­£åœ¨é‡è¿...";
            }
        }

        // å¯¼èˆªåˆ‡æ¢
        const menus = document.querySelectorAll(".menu a");
        const pages = document.querySelectorAll(".page");
        const title = document.getElementById("title");

        menus.forEach(m => {
            m.onclick = () => {
                menus.forEach(x => x.classList.remove("active"));
                m.classList.add("active");
                pages.forEach(p => p.classList.remove("active"));
                document.getElementById("page-" + m.dataset.page).classList.add("active");
                title.innerText = m.innerText;
            };
        });

        // åŠ è½½æ•°æ®
        async function load() {
            const demoData = [
                {
                    MachineInfo: { HostName: "ç”Ÿäº§æœåŠ¡å™¨-01" },
                    Ip: "192.168.1.101",
                    AppInfo: { AppName: "ç”Ÿäº§ç®¡ç†ç³»ç»Ÿ", Version: "2.1.5" },
                    InstanceInfo: { StartTime: new Date() }
                },
                {
                    MachineInfo: { HostName: "ç¼“å­˜æœåŠ¡å™¨-01" },
                    Ip: "192.168.1.105",
                    AppInfo: { AppName: "ç¼“å­˜æœåŠ¡", Version: "1.5.0" },
                    InstanceInfo: { StartTime: new Date() }
                },
                {
                    MachineInfo: { HostName: "æ•°æ®åº“æœåŠ¡å™¨" },
                    Ip: "192.168.1.102",
                    AppInfo: { AppName: "æ•°æ®åº“ç›‘æ§", Version: "3.0.1" },
                    InstanceInfo: { StartTime: new Date() }
                }
            ];

            try {
                allDevices = await fetch(APIList).then(r => r.json()).catch(() => demoData);
                
                document.getElementById("total").innerText = allDevices.length;
                document.getElementById("online").innerText = allDevices.length;
                document.getElementById("today").innerText = allDevices.length;

                renderDeviceTable();
            } catch (error) {
                console.error("åŠ è½½æ•°æ®å¤±è´¥:", error);
            }
        }

        // æ¸²æŸ“è®¾å¤‡åˆ—è¡¨ï¼ˆæ”¯æŒè¿‡æ»¤ï¼‰
        function renderDeviceTable() {
            const filterValue = document.getElementById("deviceFilter").value.trim().toLowerCase();
            
            // è¿‡æ»¤è®¾å¤‡
            const filteredDevices = allDevices.filter(device => {
                if (!filterValue) return true;
                
                const hostName = (device.MachineInfo?.HostName || "").toLowerCase();
                const ip = (device.Ip || "").toLowerCase();
                const appName = (device.AppInfo?.AppName || "").toLowerCase();
                const filter = filterValue.toLowerCase();
                
                // æ”¯æŒIPå‰å‡ ä½åŒ¹é…ï¼ˆå¦‚ "192.168" æˆ– "192.168.1"ï¼‰
                return hostName.includes(filter) || 
                       ip.includes(filter) || 
                       appName.includes(filter);
            });

            // æ›´æ–°è¿‡æ»¤è®¡æ•°
            const filterCountEl = document.getElementById("filterCount");
            if (filterValue) {
                filterCountEl.textContent = `æœç´¢ "${filterValue}"ï¼Œæ˜¾ç¤º ${filteredDevices.length} æ¡ï¼ˆæ€»è®¡ ${allDevices.length} æ¡ï¼‰`;
            } else {
                filterCountEl.textContent = `æ˜¾ç¤º ${filteredDevices.length} æ¡`;
            }

            const tb = document.getElementById("tbody");
            if (filteredDevices.length === 0) {
                tb.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: #94a3b8; padding: 40px;">
                            ${filterValue ? 'æ²¡æœ‰åŒ¹é…çš„è®¾å¤‡' : 'æš‚æ— è®¾å¤‡æ•°æ®ï¼Œç‚¹å‡»åˆ·æ–°æŒ‰é’®è·å–æœ€æ–°æ•°æ®'}
                        </td>
                    </tr>`;
            } else {
                tb.innerHTML = filteredDevices.map(d => `
                    <tr>
                        <td><strong>${d.MachineInfo?.HostName || "-"}</strong></td>
                        <td><code style="background: #f1f5f9; padding: 2px 6px; border-radius: 4px; font-size: 12px;">${d.Ip || "-"}</code></td>
                        <td>${d.AppInfo?.AppName || "-"}</td>
                        <td><span class="tag warn">${d.AppInfo?.Version || "-"}</span></td>
                        <td><span class="tag online">â— åœ¨çº¿</span></td>
                        <td style="color: #64748b;">${d.InstanceInfo?.StartTime ? new Date(d.InstanceInfo.StartTime).toLocaleString() : "-"}</td>
                    </tr>
                `).join("");
            }
        }

        // è¿‡æ»¤è®¾å¤‡ï¼ˆé˜²æŠ–ï¼‰
        let filterTimer = null;
        function filterDevices() {
            if (filterTimer) clearTimeout(filterTimer);
            filterTimer = setTimeout(() => {
                renderDeviceTable();
            }, 300); // 300ms é˜²æŠ–
        }

        // æ›´æ–°åˆ·æ–°é—´éš”
        function updateRefreshInterval() {
            const intervalInput = document.getElementById("refreshInterval");
            let value = parseInt(intervalInput.value, 10);
            if (isNaN(value) || value < 1) value = 1;
            if (value > 60) value = 60;
            intervalInput.value = value;
            
            refreshInterval = value * 1000;
            
            // é‡æ–°å¯åŠ¨å®šæ—¶å™¨
            if (refreshTimer) {
                clearInterval(refreshTimer);
            }
            refreshTimer = setInterval(load, refreshInterval);
        }

        // åˆå§‹åŒ–
        connection.onclose(async () => {
            updateConnectionStatus(false);
        });

        // åˆå§‹åŒ–åˆ·æ–°é—´éš”å¹¶å¯åŠ¨
        updateRefreshInterval();
        startConnection();
        load();
    </script>
</body>

</html>